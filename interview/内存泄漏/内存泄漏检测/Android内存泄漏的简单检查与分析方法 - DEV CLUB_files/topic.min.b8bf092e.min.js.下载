!function(){var t=null,e=$(".replies_history"),n=e.find(".inner_content");e.hide(),e.on("mouseenter",function(){clearTimeout(t)}).on("mouseleave",function(){e.fadeOut("fast")}),0===$(".reply2_item").length&&$("#content").on("mouseenter",".reply_content a",function(a){clearTimeout(t);var o=$(this);if("@"===o.text()[0]){var i=o.text().trim(),s=(i.slice(1),o.offset()),r=o.width(),c=$("#main").offset();e.css("left",s.left-c.left+r+10),e.css("top",s.top-c.top-10),e.css({"z-index":1}),n.empty();for(var l=[],u=o.closest(".reply_item").attr("reply_to_id");u;){var p=$(".reply_item[reply_id="+u+"]"),d=p.find(".reply_content").text().trim();d.length>0&&l.push([$(p.find(".user_avatar").html()).attr({height:"30px",width:"30px"}),d.length>300?d.substr(0,300)+"...":d,'<a href="#'+u+'" class="scroll_to_original" title="查看原文">↑</a>']),u=p.attr("reply_to_id")}l.length>0?(l.reverse(),n.append('<div class="title">查看对话</div>'),l.forEach(function(t,e){var a=n.append('<div class="item"></div>');a.append(t[0]),a.append($("<span>").text(t[1])),a.append(t[2])}),e.fadeIn("fast")):e.hide()}}).on("mouseleave",".reply_content a",function(n){t=setTimeout(function(){e.fadeOut("fast")},500)})}(),$(".up_topic_btn").click(function(t){var e=$(this),n=e.attr("topic_id");$.ajax({url:"/topic/"+n+"/up",method:"POST"}).done(function(t){if(t.success){var n=Number(e.next(".up-count").text().trim())||0;"up"===t.action?(e.next(".up-count").text(n+1),e.addClass("uped"),e.removeClass("fa-thumbs-o-up"),e.addClass("fa-thumbs-up")):"down"===t.action&&(e.next(".up-count").text(n-1),e.removeClass("uped"),e.addClass("fa-thumbs-o-up"),e.removeClass("fa-thumbs-up"))}else alert(t.message)}).fail(function(t){403===t.status&&alert("请先登录，登陆后即可点赞。")})}),$(".accept_btn").click(function(){var t=$(this),e=t.closest(".reply_area").attr("reply_id"),n={tid:"<%=topic._id %>"},a=confirm("确定要采纳改评论为答案吗？采纳后不能修改！");a&&$.ajax({url:"/reply/"+e+"/accept",method:"POST",data:n}).done(function(t){t.success?location.reload():alert(t.message)}).fail(function(t){})}),$(".up_btn").click(function(t){var e=$(this),n=e.closest(".reply_area").attr("reply_id");$.ajax({url:"/reply/"+n+"/up",method:"POST"}).done(function(t){if(t.success){e.removeClass("invisible");var n=Number(e.next(".up-count").text().trim())||0;"up"===t.action?(e.next(".up-count").text(n+1),e.addClass("uped")):"down"===t.action&&(e.next(".up-count").text(n-1),e.removeClass("uped"))}else alert(t.message)}).fail(function(t){403===t.status&&alert("请先登录，登陆后即可点赞。")})}),function(){function t(t){a.attr("src",t),n.modal("show"),o.css("overflow-y","hidden")}function e(){n.modal("hide")}var n=$("#preview-modal"),a=$("#preview-image"),o=$("body");$(document).on("click",".markdown-text img",function(e){var n=$(this);n.parent("a").length>0||t(n.attr("src"))}),n.on("click",e),n.on("hidden.bs.modal",function(){o.css("overflow-y","scroll")}),n.on("shown.bs.modal",function(){n.scrollTop(0)})}();
$(document).ready(function(){var e=$(".reply_author").map(function(e,t){return $(t).text().trim()}).toArray();e.push($(".user_card .user_name").text()),e=_.uniq(e),$("textarea.editor").each(function(){var t=new Editor({status:[]}),r=$(this);t.render(this),$(this).data("editor",t);var o=$(t.codemirror.display.input);o.keydown(function(e){13===e.keyCode&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),r.closest("form").submit())});var n=CodeMirror.commands.goLineUp,a=CodeMirror.commands.goLineDown,i=CodeMirror.commands.newlineAndIndent;o.atwho({at:"@",data:e}).on("shown.atwho",function(){CodeMirror.commands.goLineUp=_.noop,CodeMirror.commands.goLineDown=_.noop,CodeMirror.commands.newlineAndIndent=_.noop}).on("hidden.atwho",function(){CodeMirror.commands.goLineUp=n,CodeMirror.commands.goLineDown=a,CodeMirror.commands.newlineAndIndent=i})}),$("#content").on("click",".reply2_btn",function(e){var t=$(e.currentTarget),r=t.closest(".reply_area"),o=r.find(".reply2_form");r.find(".reply2_area").prepend(o);var n=o.find("textarea.editor"),a=t.closest(".author_content").find(".reply_author").text().trim(),i=n.data("editor");o.show("fast",function(){var e=i.codemirror;e.focus(),e.getValue().indexOf("@"+a)<0&&i.push("@"+a+" ")})}),$("#content").on("click",".reply2_at_btn",function(e){var t=$(e.currentTarget),r=t.closest(".reply2_area").find(".reply2_form");t.closest(".reply2_item").after(r);var o=r.find("textarea.editor"),n=t.closest(".reply2_item").find(".reply_author").text().trim(),a=o.data("editor");r.show("fast",function(){var e=a.codemirror;e.focus(),e.getValue().indexOf("@"+n)<0&&a.push("@"+n+" ")})}),$("#collect").click(function(){var e=$(this),t=e.attr("action"),r=e.data("id"),o={topic_id:r,_csrf:$("#_csrf").val()};$.post("/topic/"+t,o,function(r){"success"===r.status&&("collect"==t?(e.attr("title","取消收藏"),e.attr("action","de_collect"),e.removeClass("fa-heart-o"),e.addClass("fa-heart")):(e.attr("title","收藏"),e.attr("action","collect"),e.removeClass("fa-heart"),e.addClass("fa-heart-o")))},"json")}),$("#content").on("click",".delete_reply_btn, .delete_reply2_btn",function(e){var t=$(e.currentTarget);if(confirm("确定要删除此回复吗？")){var r=null;t.hasClass("delete_reply_btn")&&(r=t.closest(".reply_item").attr("reply_id")),t.hasClass("delete_reply2_btn")&&(r=t.closest(".reply2_item").attr("reply_id"));var o={reply_id:r,_csrf:$("#_csrf").val()};$.post("/reply/"+r+"/delete",o,function(e){"success"===e.status&&(t.hasClass("delete_reply_btn")&&t.closest(".reply_item").remove(),t.hasClass("delete_reply2_btn")&&t.closest(".reply2_item").remove())},"json")}return!1}),$(".delete_topic_btn").click(function(){var e=$(this).data("id");return e&&confirm("确定要删除此话题吗？")&&$.post("/topic/"+e+"/delete",{_csrf:$("#_csrf").val()},function(e){e.success?location.href="/":alert(e.message)}),!1}),$(".wechat_topic_btn").click(function(){var e=$(this).data("id");return e&&$.get("/topic/"+e+"/qrcode",{_csrf:$("#_csrf").val()},function(e){e.url?($("#qrcode-loading").hide(),$("#qrcode-image").attr("src",e.url).show()):$("#qrcode-modal").modal("hide")}),$("#qrcode-modal").modal(),$("#qrcode-loading").show(),$("#qrcode-image").hide(),!1}),$(".reply_area").hover(function(){$(this).find(".up_btn").removeClass("invisible")},function(){var e=$(this);""===e.find(".up-count").text().trim()&&e.find(".up_btn").addClass("invisible")})});
